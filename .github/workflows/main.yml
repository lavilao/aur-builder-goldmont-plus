name: Build and Release zed-git (Debian)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Build zed-git for Debian
        run: |
          docker run --rm ubuntu:22.04 /bin/bash -c "
            set -e

            # Update and install base tools and dependencies
            apt-get update
            apt-get install -y --no-install-recommends \
              build-essential \
              gcc \
              g++ \
              libasound2-dev \
              libfontconfig-dev \
              libwayland-dev \
              libx11-xcb-dev \
              libxkbcommon-x11-dev \
              libssl-dev \
              libzstd-dev \
              libvulkan1 \
              libgit2-dev \
              make \
              cmake \
              clang \
              jq \
              git \
              curl \
              gettext-base \
              elfutils \
              libsqlite3-dev \
              musl-tools \
              musl-dev \
              pkg-config \
              nodejs \
              npm \
              protobuf-compiler \
              libvulkan-dev \
              libvulkan1 \
              vulkan-validationlayers-dev \
              libxcb1-dev \
              libxkbcommon-dev \
              ca-certificates \
              gnupg

            # Install rustup and rust
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source ~/.cargo/env

            # Clone the zed repository
            git clone --depth 1 https://github.com/zed-industries/zed.git
            cd zed

            # Set environment variables for GLES support and goldmont-plus optimization
            export RUSTFLAGS='--cfg gles'
            export CFLAGS='-march=goldmont-plus -mtune=goldmont-plus'
            export CXXFLAGS='-march=goldmont-plus -mtune=goldmont-plus'

            # Build zed with release profile
            cargo build --release --package zed --package cli

            # Create a simple packaging structure
            mkdir -p /tmp/zed-debian-build/usr/bin
            mkdir -p /tmp/zed-debian-build/usr/lib/zed
            cp target/release/cli /tmp/zed-debian-build/usr/bin/zed
            cp target/release/zed /tmp/zed-debian-build/usr/lib/zed/zed-editor

            # Create a simple .deb package
            cd /tmp
            mkdir -p zed-debian-package/DEBIAN
            mkdir -p zed-debian-package/usr/bin
            mkdir -p zed-debian-package/usr/lib/zed

            # Create control file
            cat > zed-debian-package/DEBIAN/control << 'EOF'
            Package: zed-git
            Version: 1.0.0-custom
            Section: devel
            Priority: optional
            Architecture: amd64
            Depends: libasound2, libfontconfig1, libwayland-client0, libx11-xcb1, libxkbcommon0, libssl3, libzstd1, libvulkan1, libsqlite3-0, libxcb1, libxkbcommon-x11-0
            Maintainer: Custom Build
            Description: Zed Editor (Git version with GLES support)
             A high-performance, multiplayer code editor from the creators of Atom and Tree-sitter
            EOF

            # Copy binaries
            cp -r zed-debian-build/usr/* zed-debian-package/usr/

            # Build the .deb package
            dpkg-deb --build --root-owner-group zed-debian-package
            mv zed-debian-package.deb zed-git-debian-amd64.deb
          "

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zed-git-debian-package
          path: zed-git-debian-amd64.deb

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: zed-git-debian-amd64.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}