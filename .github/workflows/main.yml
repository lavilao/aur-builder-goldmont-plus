name: Build and Release Arch Linux Packages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Patch Local PKGBUILD
        run: |
          # 1. Verify file exists
          if [ ! -f "PKGBUILD" ]; then
            echo "::error::PKGBUILD file not found in repository root!"
            exit 1
          fi

          # 2. FIX: pkgver empty error
          # We replace the existing pkgver with a placeholder (0.0.0) so 'makepkg' can parse the file initially.
          sed -i 's/^pkgver=.*/pkgver=0.0.0/' PKGBUILD

          # 3. Inject pkgver() function
          # Create pkgver function in a separate file to avoid YAML parsing issues
          cat > /tmp/pkgver_function.sh << 'EOF'
          pkgver() {
            cd "zed"
            local lasttag="$(git tag --sort=-v:refname | grep -E -m1 '^v[0-9]+\.[0-9]+\.[0-9]+-pre$' )"
            echo -n "$(sed 's/^v//;s/-pre$//' <<< "$lasttag")"
            echo -n ".r$(git rev-list "$(git merge-base HEAD "$lasttag")..HEAD" --count)"
            echo -n ".g$(git log --pretty=format:'%h' --abbrev-commit)"
          }
          EOF
          
          # Insert the function after pkgrel=1
          sed -i '/^pkgrel=1$/r /tmp/pkgver_function.sh' PKGBUILD

      - name: Build package
        run: |
          # Install build dependencies if needed
          sudo pacman -S --needed base-devel

          # Build the package
          makepkg -s

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.pkg.tar.*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
