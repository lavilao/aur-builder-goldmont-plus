name: Build and Release Arch Linux Packages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Patch Local PKGBUILD
        run: |
          # 1. Verify file exists
          if [ ! -f "PKGBUILD" ]; then
            echo "::error::PKGBUILD file not found in repository root!"
            exit 1
          fi

          # 2. FIX: pkgver empty error
          # We replace the existing pkgver with a placeholder (0.0.0) so 'makepkg' can parse the file initially.
          sed -i 's/^pkgver=.*/pkgver=0.0.0/' PKGBUILD

          # 3. Inject pkgver() function
          # We inject the dynamic version logic after 'pkgrel=1'
          # FIX: We cd into "zed" (upstream repo name), not "zed-git"
          # FIX: We use 'grep -m1' to prevent "Broken Pipe" errors
          sed -i '/^pkgrel=1$/a pkgver() {\ncd "zed"\nlocal lasttag="$(git tag --sort=-v:refname | grep -E -m1 '\''^v[0-9]+\.[0-9]+\.[0-9]+-pre$'\'' )"\necho -n "$(sed '\''s/^v//;s/-pre$//'\'' <<< "$lasttag")"\necho -n ".r$(git rev-list "$(git merge-base HEAD "$lasttag")..HEAD" --count)"\necho -n ".g$(git log --pretty=format:'\''%h'\'' --abbrev
