name: Build and Release Arch Linux Packages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout zed repository
        uses: actions/checkout@v4
        with:
          repository: zed-industries/zed
          path: zed
          fetch-depth: 0

      - name: Build package using Arch Linux in Docker
        run: |
          docker run --rm \
            -v "$PWD":/build \
            -e MAKEFLAGS="-j$(nproc)" \
            archlinux:latest /bin/bash -c "
              set -e
              
              # Update system and install all required dependencies
              pacman -Syu --noconfirm
              pacman -S --noconfirm base-devel git binutils fakeroot rust \
                alsa-lib fontconfig libxcb libxkbcommon libxkbcommon-x11 \
                netcat nodejs npm vulkan-driver vulkan-icd-loader \
                vulkan-tools wayland cargo-about clang cmake protobuf \
                vulkan-headers vulkan-validation-layers
              
              # Create build user
              useradd -m -s /bin/bash auruser 2>/dev/null || true
              
              # Copy files to build directory
              cp /build/PKGBUILD /tmp/
              cp -r /build/zed /tmp/
              chown -R auruser:auruser /tmp
              
              # Build as auruser
              sudo -u auruser bash -c '
                cd /tmp
                makepkg -s --noconfirm --skipinteg
                cp *.pkg.tar.* /build/
              '
            "

      - name: List built packages
        run: |
          ls -la *.pkg.tar.* 2>/dev/null || echo "No packages found"

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.pkg.tar.*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}