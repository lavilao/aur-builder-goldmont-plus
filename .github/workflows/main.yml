name: Build and Release Arch Linux Packages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build in Arch Linux container
        run: |
          # Create a temporary script for the container
          cat > /tmp/build_script.sh << 'SCRIPT_END'
          #!/bin/bash
          set -e
          
          # Update and install base-devel
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git
            
          # Copy PKGBUILD to container
          cp /build/PKGBUILD /tmp/
          cd /tmp
            
          # 1. Verify file exists
          if [ ! -f PKGBUILD ]; then
            echo '::error::PKGBUILD file not found!'
            exit 1
          fi

          # 2. FIX: pkgver empty error
          sed -i 's/^pkgver=.*/pkgver=0.0.0/' PKGBUILD

          # 3. Inject pkgver() function
          cat > /tmp/pkgver_function.sh << 'EOF'
          pkgver() {
            cd "zed"
            local lasttag="$(git tag --sort=-v:refname | grep -E -m1 '^v[0-9]+\.[0-9]+\.[0-9]+-pre$' )"
            echo -n "$(sed 's/^v//;s/-pre$//' <<< "$lasttag")"
            echo -n ".r$(git rev-list "$(git merge-base HEAD "$lasttag")..HEAD" --count)"
            echo -n ".g$(git log --pretty=format:'%h' --abbrev-commit)"
          }
          EOF
            
          # Insert the function after pkgrel=1
          sed -i '/^pkgrel=1$/r /tmp/pkgver_function.sh' PKGBUILD

          # Build the package
          makepkg -s

          # Copy the built package back to the host
          cp *.pkg.tar.* /build/
          SCRIPT_END

          # Run the build process in an Arch Linux Docker container
          docker run --rm -v "$PWD":/build -v /tmp/build_script.sh:/build_script.sh archlinux:latest /bin/bash /build_script.sh

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.pkg.tar.*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
