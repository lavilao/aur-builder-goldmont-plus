name: Build and Release Arch Linux Packages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build package using Arch Linux in Docker
        run: |
          # Run Arch Linux container with proper configuration for AUR building
          docker run --rm \
            -v "$PWD":/build \
            -e MAKEFLAGS="-j$(nproc)" \
            archlinux:latest /bin/bash -c "
              set -e
              
              # Update system and install build tools
              pacman -Syu --noconfirm
              pacman -S --noconfirm base-devel git binutils fakeroot
            
              # Create a non-root user for building
              useradd -m -s /bin/bash auruser 2>/dev/null || true
              
              # Copy files and change ownership
              cp /build/PKGBUILD /tmp/
              chown -R auruser:auruser /tmp
              
              # Switch to auruser for building
              sudo -u auruser bash << 'EOF'
                set -e
                
                cd /tmp
                
                # 1. Verify PKGBUILD exists
                if [ ! -f PKGBUILD ]; then
                  echo '::error::PKGBUILD file not found!'
                  exit 1
                fi

                # 2. Replace pkgver with placeholder
                sed -i 's/^pkgver=.*/pkgver=0.0.0/' PKGBUILD

                # 3. Add pkgver() function
                cat > pkgver_function.sh << 'FUNC_EOF'
                pkgver() {
                  cd 'zed'
                  local lasttag=\"\$(git tag --sort=-v:refname | grep -E -m1 '^v[0-9]+\.[0-9]+\.[0-9]+-pre$' )\"
                  echo -n \"\$(sed 's/^v//;s/-pre$//' <<< \"\$lasttag\")\"
                  echo -n \".r\$(git rev-list \"\$(git merge-base HEAD \"\$lasttag\")..HEAD\" --count)\"
                  echo -n \".g\$(git log --pretty=format:'%h' --abbrev-commit)\"
                }
                FUNC_EOF
                
                # Insert function after pkgrel=1
                sed -i '/^pkgrel=1$/r pkgver_function.sh' PKGBUILD
                
                # Build package
                makepkg -s --noconfirm --skipinteg
                
                # Copy built packages
                cp *.pkg.tar.* /build/ 2>/dev/null || echo 'No packages built'
              EOF
            "

      - name: List built packages
        run: |
          ls -la *.pkg.tar.* 2>/dev/null || echo "No packages found"

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.pkg.tar.*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
